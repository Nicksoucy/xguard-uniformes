<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>XGuard - Gestion d'Uniformes</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <style>
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        @keyframes slideIn {
            from { transform: translateX(-100%); }
            to { transform: translateX(0); }
        }
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-fadeIn { animation: fadeIn 0.5s ease-out; }
        .animate-slideIn { animation: slideIn 0.3s ease-out; }
        .animate-pulse { animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite; }
        .glass-morphism {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        .gradient-bg {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        .gradient-text {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .card-hover:hover {
            transform: translateY(-2px);
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
        }
        #signature-pad {
            border: 2px solid #e5e7eb;
            border-radius: 8px;
            background: white;
            touch-action: none;
        }
    </style>
</head>
<body class="bg-gray-50">
    <div id="app"></div>

    <script>
        // Base de données LocalStorage
        class Database {
            constructor() {
                this.initializeDefaults();
            }

            initializeDefaults() {
                if (!localStorage.getItem('xguard_initialized')) {
                    const defaultInventory = [
                        { id: 1, name: 'Chemise ML', sizes: { S: 50, M: 100, L: 75, XL: 40, XXL: 20, '3XL': 10 }, price: 30, category: 'Hauts' },
                        { id: 2, name: 'Chemise MC', sizes: { S: 40, M: 80, L: 60, XL: 30, XXL: 15, '3XL': 5 }, price: 25, category: 'Hauts' },
                        { id: 3, name: 'Col rond', sizes: { S: 60, M: 120, L: 90, XL: 50, XXL: 25, '3XL': 15 }, price: 20, category: 'Hauts' },
                        { id: 4, name: 'Polo', sizes: { S: 30, M: 60, L: 45, XL: 25, XXL: 10, '3XL': 5 }, price: 35, category: 'Hauts' },
                        { id: 5, name: 'Pantalon', sizes: { '28': 20, '30': 30, '32': 40, '34': 50, '36': 40, '38': 30, '40': 20 }, price: 45, category: 'Bas' },
                        { id: 6, name: 'Coupe-vent', sizes: { S: 20, M: 40, L: 30, XL: 20, XXL: 10, '3XL': 5 }, price: 60, category: 'Extérieur' },
                        { id: 7, name: 'Manteau 3 en 1', sizes: { S: 15, M: 30, L: 25, XL: 15, XXL: 10, '3XL': 5 }, price: 120, category: 'Extérieur' },
                        { id: 8, name: 'Tuque', sizes: { 'Unique': 100 }, price: 15, category: 'Accessoires' },
                        { id: 9, name: 'Casquette', sizes: { 'Unique': 80 }, price: 20, category: 'Accessoires' },
                        { id: 10, name: 'Ceinture', sizes: { 'S': 30, 'M': 40, 'L': 30 }, price: 25, category: 'Accessoires' },
                        { id: 11, name: 'Dossard', sizes: { 'Unique': 50 }, price: 10, category: 'Sécurité' },
                        { id: 12, name: 'Casque-chantier', sizes: { 'Unique': 40 }, price: 30, category: 'Sécurité' },
                        { id: 13, name: 'Épaulettes', sizes: { 'Unique': 60 }, price: 15, category: 'Accessoires' }
                    ];
                    
                    localStorage.setItem('inventory', JSON.stringify(defaultInventory));
                    localStorage.setItem('employees', JSON.stringify([]));
                    localStorage.setItem('transactions', JSON.stringify([]));
                    localStorage.setItem('inventoryHistory', JSON.stringify([]));
                    localStorage.setItem('xguard_initialized', 'true');
                }
            }

            // Employés
            getEmployees() {
                return JSON.parse(localStorage.getItem('employees') || '[]');
            }

            getActiveEmployees() {
                return this.getEmployees().filter(e => e.active);
            }

            getInactiveEmployees() {
                return this.getEmployees().filter(e => !e.active);
            }

            getEmployeeById(id) {
                return this.getEmployees().find(e => e.id === id);
            }

            addEmployee(employee) {
                const employees = this.getEmployees();
                const newEmployee = {
                    id: 'EMP' + String(employees.length + 1).padStart(3, '0'),
                    ...employee,
                    active: true,
                    createdAt: new Date().toISOString()
                };
                employees.push(newEmployee);
                localStorage.setItem('employees', JSON.stringify(employees));
                return newEmployee;
            }

            updateEmployee(id, updates) {
                const employees = this.getEmployees();
                const index = employees.findIndex(e => e.id === id);
                if (index !== -1) {
                    employees[index] = { ...employees[index], ...updates };
                    localStorage.setItem('employees', JSON.stringify(employees));
                }
            }

            // Transactions
            getTransactions() {
                return JSON.parse(localStorage.getItem('transactions') || '[]');
            }

            getTransactionsByEmployee(employeeId) {
                return this.getTransactions().filter(t => t.employeeId === employeeId);
            }

            getTransactionById(id) {
                return this.getTransactions().find(t => t.id === id);
            }

            getTransactionByToken(token) {
                return this.getTransactions().find(t => t.linkToken === token);
            }

            getPendingSignatures() {
                return this.getTransactions().filter(t => !t.signed && t.type !== 'retour');
            }

            addTransaction(transaction) {
                const transactions = this.getTransactions();
                const newTransaction = {
                    id: Date.now().toString(),
                    ...transaction,
                    createdAt: new Date().toISOString(),
                    signed: false
                };
                if (transaction.type !== 'retour') {
                    newTransaction.linkToken = this.generateToken();
                }
                transactions.push(newTransaction);
                localStorage.setItem('transactions', JSON.stringify(transactions));
                return newTransaction;
            }

            updateTransaction(id, updates) {
                const transactions = this.getTransactions();
                const index = transactions.findIndex(t => t.id === id);
                if (index !== -1) {
                    transactions[index] = { ...transactions[index], ...updates };
                    localStorage.setItem('transactions', JSON.stringify(transactions));
                }
            }

            generateToken() {
                return Math.random().toString(36).substring(2) + Date.now().toString(36);
            }

            // Inventaire
            getInventory() {
                return JSON.parse(localStorage.getItem('inventory') || '[]');
            }

            getInventoryItem(id) {
                return this.getInventory().find(i => i.id === id);
            }

            updateInventoryItem(id, updates) {
                const inventory = this.getInventory();
                const index = inventory.findIndex(i => i.id === id);
                if (index !== -1) {
                    inventory[index] = { ...inventory[index], ...updates };
                    localStorage.setItem('inventory', JSON.stringify(inventory));
                }
            }

            addInventoryItem(item) {
                const inventory = this.getInventory();
                const newItem = {
                    id: Math.max(...inventory.map(i => i.id)) + 1,
                    ...item
                };
                inventory.push(newItem);
                localStorage.setItem('inventory', JSON.stringify(inventory));
                return newItem;
            }

            updateInventoryStock(itemId, size, quantity, action = 'adjust') {
                const item = this.getInventoryItem(itemId);
                if (item && item.sizes[size] !== undefined) {
                    if (action === 'add') {
                        item.sizes[size] += quantity;
                    } else if (action === 'remove') {
                        item.sizes[size] = Math.max(0, item.sizes[size] - quantity);
                    } else {
                        item.sizes[size] = quantity;
                    }
                    this.updateInventoryItem(itemId, item);
                    this.addInventoryHistory({
                        itemId,
                        itemName: item.name,
                        size,
                        quantity,
                        action,
                        timestamp: new Date().toISOString()
                    });
                }
            }

            getInventoryHistory() {
                return JSON.parse(localStorage.getItem('inventoryHistory') || '[]');
            }

            addInventoryHistory(entry) {
                const history = this.getInventoryHistory();
                history.push(entry);
                localStorage.setItem('inventoryHistory', JSON.stringify(history));
            }

            getLowStockItems() {
                const inventory = this.getInventory();
                const lowStock = [];
                inventory.forEach(item => {
                    Object.entries(item.sizes).forEach(([size, quantity]) => {
                        if (quantity < 10) {
                            lowStock.push({
                                ...item,
                                size,
                                quantity
                            });
                        }
                    });
                });
                return lowStock;
            }

            // Export/Import
            exportData() {
                return {
                    employees: this.getEmployees(),
                    transactions: this.getTransactions(),
                    inventory: this.getInventory(),
                    inventoryHistory: this.getInventoryHistory(),
                    exportDate: new Date().toISOString()
                };
            }

            importData(data) {
                if (data.employees) localStorage.setItem('employees', JSON.stringify(data.employees));
                if (data.transactions) localStorage.setItem('transactions', JSON.stringify(data.transactions));
                if (data.inventory) localStorage.setItem('inventory', JSON.stringify(data.inventory));
                if (data.inventoryHistory) localStorage.setItem('inventoryHistory', JSON.stringify(data.inventoryHistory));
            }
        }

        // Application principale
        class XGuardApp {
            constructor() {
                this.db = new Database();
                this.currentView = 'home';
                this.selectedEmployee = null;
                this.currentTransaction = {
                    type: null,
                    items: [],
                    notes: ''
                };
                this.signaturePad = null;
                this.init();
            }

            init() {
                // Vérifier si on a un token de signature dans l'URL
                const urlParams = new URLSearchParams(window.location.search);
                const token = urlParams.get('token');
                
                if (token) {
                    const transaction = this.db.getTransactionByToken(token);
                    if (transaction && !transaction.signed) {
                        this.showSignaturePage(transaction);
                        return;
                    }
                }
                
                this.render();
            }

            render() {
                const app = document.getElementById('app');
                app.innerHTML = `
                    <div class="min-h-screen">
                        ${this.renderHeader()}
                        <main class="container mx-auto px-4 py-8">
                            ${this.renderContent()}
                        </main>
                    </div>
                `;
                this.attachEventListeners();
            }

            renderHeader() {
                return `
                    <header class="gradient-bg text-white sticky top-0 z-50 shadow-lg">
                        <div class="container mx-auto px-4">
                            <div class="flex items-center justify-between h-16">
                                <div class="flex items-center space-x-4">
                                    <h1 class="text-2xl font-bold cursor-pointer" onclick="app.navigate('home')">
                                        XGuard
                                    </h1>
                                    <nav class="hidden md:flex space-x-4">
                                        <button onclick="app.navigate('home')" class="hover:opacity-80 transition">Accueil</button>
                                        <button onclick="app.navigate('employees')" class="hover:opacity-80 transition">Employés</button>
                                        <button onclick="app.navigate('inventory')" class="hover:opacity-80 transition">Inventaire</button>
                                        <button onclick="app.navigate('transactions')" class="hover:opacity-80 transition">Transactions</button>
                                    </nav>
                                </div>
                                <div class="flex items-center space-x-2">
                                    <button onclick="app.exportData()" class="bg-white/20 hover:bg-white/30 px-4 py-2 rounded-lg transition">
                                        Export
                                    </button>
                                </div>
                            </div>
                        </div>
                    </header>
                `;
            }

            renderContent() {
                switch(this.currentView) {
                    case 'home':
                        return this.renderDashboard();
                    case 'employees':
                        return this.renderEmployeesList();
                    case 'employee-detail':
                        return this.renderEmployeeDetail();
                    case 'new-transaction':
                        return this.renderNewTransaction();
                    case 'select-employee':
                        return this.renderSelectEmployee();
                    case 'select-items':
                        return this.renderSelectItems();
                    case 'transaction-summary':
                        return this.renderTransactionSummary();
                    case 'inventory':
                        return this.renderInventoryManagement();
                    case 'transactions':
                        return this.renderTransactionsList();
                    case 'signatures':
                        return this.renderPendingSignatures();
                    default:
                        return this.renderDashboard();
                }
            }

            renderDashboard() {
                const employees = this.db.getActiveEmployees();
                const transactions = this.db.getTransactions();
                const pendingSignatures = this.db.getPendingSignatures();
                const lowStockItems = this.db.getLowStockItems();

                return `
                    <div class="animate-fadeIn">
                        <h2 class="text-3xl font-bold gradient-text mb-8">Tableau de bord</h2>
                        
                        <!-- Statistiques -->
                        <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
                            <div class="bg-white rounded-xl shadow-md p-6 card-hover transition-all">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-500 text-sm">Employés actifs</p>
                                        <p class="text-3xl font-bold text-gray-800">${employees.length}</p>
                                    </div>
                                    <div class="bg-purple-100 p-3 rounded-lg">
                                        <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-xl shadow-md p-6 card-hover transition-all">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-500 text-sm">Total transactions</p>
                                        <p class="text-3xl font-bold text-gray-800">${transactions.length}</p>
                                    </div>
                                    <div class="bg-indigo-100 p-3 rounded-lg">
                                        <svg class="w-8 h-8 text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-xl shadow-md p-6 card-hover transition-all">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-500 text-sm">Signatures en attente</p>
                                        <p class="text-3xl font-bold ${pendingSignatures.length > 0 ? 'text-orange-600' : 'text-gray-800'}">${pendingSignatures.length}</p>
                                    </div>
                                    <div class="bg-orange-100 p-3 rounded-lg">
                                        <svg class="w-8 h-8 text-orange-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-xl shadow-md p-6 card-hover transition-all">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <p class="text-gray-500 text-sm">Stock faible</p>
                                        <p class="text-3xl font-bold ${lowStockItems.length > 0 ? 'text-red-600' : 'text-gray-800'}">${lowStockItems.length}</p>
                                    </div>
                                    <div class="bg-red-100 p-3 rounded-lg">
                                        <svg class="w-8 h-8 text-red-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path>
                                        </svg>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Actions rapides -->
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
                            <button onclick="app.startNewTransaction()" class="bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition-all group">
                                <div class="flex items-center space-x-4">
                                    <div class="bg-gradient-to-r from-purple-500 to-indigo-600 p-4 rounded-lg group-hover:scale-110 transition-transform">
                                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                        </svg>
                                    </div>
                                    <div class="text-left">
                                        <h3 class="text-lg font-semibold text-gray-800">Nouvelle transaction</h3>
                                        <p class="text-gray-500">Attribution, retour ou ajout</p>
                                    </div>
                                </div>
                            </button>
                            
                            <button onclick="app.navigate('employees')" class="bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition-all group">
                                <div class="flex items-center space-x-4">
                                    <div class="bg-gradient-to-r from-indigo-500 to-purple-600 p-4 rounded-lg group-hover:scale-110 transition-transform">
                                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path>
                                        </svg>
                                    </div>
                                    <div class="text-left">
                                        <h3 class="text-lg font-semibold text-gray-800">Gérer les employés</h3>
                                        <p class="text-gray-500">Ajouter ou modifier</p>
                                    </div>
                                </div>
                            </button>
                            
                            <button onclick="app.navigate('signatures')" class="bg-white rounded-xl shadow-md p-6 hover:shadow-lg transition-all group">
                                <div class="flex items-center space-x-4">
                                    <div class="bg-gradient-to-r from-orange-500 to-red-600 p-4 rounded-lg group-hover:scale-110 transition-transform">
                                        <svg class="w-8 h-8 text-white" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
                                        </svg>
                                    </div>
                                    <div class="text-left">
                                        <h3 class="text-lg font-semibold text-gray-800">Signatures en attente</h3>
                                        <p class="text-gray-500">${pendingSignatures.length} signature(s) à obtenir</p>
                                    </div>
                                </div>
                            </button>
                        </div>
                        
                        <!-- Alertes -->
                        ${lowStockItems.length > 0 ? `
                            <div class="bg-red-50 border border-red-200 rounded-xl p-6">
                                <h3 class="text-lg font-semibold text-red-800 mb-4">⚠️ Articles en stock faible</h3>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    ${lowStockItems.slice(0, 4).map(item => `
                                        <div class="flex justify-between items-center">
                                            <span class="text-gray-700">${item.name} (${item.size})</span>
                                            <span class="font-semibold text-red-600">${item.quantity} unités</span>
                                        </div>
                                    `).join('')}
                                </div>
                                ${lowStockItems.length > 4 ? `
                                    <p class="text-gray-600 mt-4">Et ${lowStockItems.length - 4} autres articles...</p>
                                ` : ''}
                                <button onclick="app.navigate('inventory')" class="mt-4 bg-red-600 text-white px-4 py-2 rounded-lg hover:bg-red-700 transition">
                                    Gérer l'inventaire
                                </button>
                            </div>
                        ` : ''}
                    </div>
                `;
            }

            renderEmployeesList() {
                const activeEmployees = this.db.getActiveEmployees();
                const inactiveEmployees = this.db.getInactiveEmployees();
                const showInactive = localStorage.getItem('showInactiveEmployees') === 'true';

                return `
                    <div class="animate-fadeIn">
                        <div class="flex justify-between items-center mb-8">
                            <h2 class="text-3xl font-bold gradient-text">Gestion des employés</h2>
                            <button onclick="app.showAddEmployeeModal()" class="gradient-bg text-white px-6 py-3 rounded-lg hover:opacity-90 transition">
                                + Nouvel employé
                            </button>
                        </div>
                        
                        <!-- Tabs -->
                        <div class="bg-white rounded-t-xl shadow-md">
                            <div class="flex border-b">
                                <button onclick="app.toggleEmployeeTab(false)" class="${!showInactive ? 'bg-purple-50 border-b-2 border-purple-600' : ''} px-6 py-3 font-medium transition">
                                    Actifs (${activeEmployees.length})
                                </button>
                                <button onclick="app.toggleEmployeeTab(true)" class="${showInactive ? 'bg-purple-50 border-b-2 border-purple-600' : ''} px-6 py-3 font-medium transition">
                                    Inactifs (${inactiveEmployees.length})
                                </button>
                            </div>
                            
                            <div class="p-6">
                                ${showInactive ? this.renderEmployeeTable(inactiveEmployees, true) : this.renderEmployeeTable(activeEmployees, false)}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderEmployeeTable(employees, inactive) {
                if (employees.length === 0) {
                    return `<p class="text-gray-500 text-center py-8">Aucun employé ${inactive ? 'inactif' : 'actif'}</p>`;
                }

                return `
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b">
                                    <th class="text-left py-3 px-4">Code</th>
                                    <th class="text-left py-3 px-4">Nom</th>
                                    <th class="text-left py-3 px-4">Téléphone</th>
                                    <th class="text-left py-3 px-4">Email</th>
                                    <th class="text-left py-3 px-4">Actions</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${employees.map(emp => `
                                    <tr class="border-b hover:bg-gray-50 transition">
                                        <td class="py-3 px-4 font-medium">${emp.id}</td>
                                        <td class="py-3 px-4">${emp.name}</td>
                                        <td class="py-3 px-4">${emp.phone || '-'}</td>
                                        <td class="py-3 px-4">${emp.email || '-'}</td>
                                        <td class="py-3 px-4">
                                            <button onclick="app.viewEmployeeDetail('${emp.id}')" class="text-purple-600 hover:text-purple-800 mr-4">
                                                Détails
                                            </button>
                                            ${inactive ? `
                                                <button onclick="app.toggleEmployeeStatus('${emp.id}')" class="text-green-600 hover:text-green-800">
                                                    Réactiver
                                                </button>
                                            ` : `
                                                <button onclick="app.toggleEmployeeStatus('${emp.id}')" class="text-red-600 hover:text-red-800">
                                                    Désactiver
                                                </button>
                                            `}
                                        </td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            }

            renderEmployeeDetail() {
                const employee = this.db.getEmployeeById(this.selectedEmployee);
                if (!employee) return '<p>Employé non trouvé</p>';

                const transactions = this.db.getTransactionsByEmployee(employee.id);
                const currentInventory = this.calculateEmployeeInventory(employee.id);

                return `
                    <div class="animate-fadeIn">
                        <div class="mb-8">
                            <button onclick="app.navigate('employees')" class="text-purple-600 hover:text-purple-800 mb-4">
                                ← Retour aux employés
                            </button>
                            <h2 class="text-3xl font-bold gradient-text">${employee.name}</h2>
                        </div>
                        
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                            <!-- Informations -->
                            <div class="bg-white rounded-xl shadow-md p-6">
                                <h3 class="text-lg font-semibold mb-4">Informations</h3>
                                <div class="space-y-3">
                                    <div>
                                        <p class="text-gray-500 text-sm">Code employé</p>
                                        <p class="font-medium">${employee.id}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-500 text-sm">Téléphone</p>
                                        <p class="font-medium">${employee.phone || '-'}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-500 text-sm">Email</p>
                                        <p class="font-medium">${employee.email || '-'}</p>
                                    </div>
                                    <div>
                                        <p class="text-gray-500 text-sm">Statut</p>
                                        <span class="${employee.active ? 'bg-green-100 text-green-800' : 'bg-red-100 text-red-800'} px-2 py-1 rounded-full text-sm">
                                            ${employee.active ? 'Actif' : 'Inactif'}
                                        </span>
                                    </div>
                                    ${employee.notes ? `
                                        <div>
                                            <p class="text-gray-500 text-sm">Notes</p>
                                            <p class="text-sm">${employee.notes}</p>
                                        </div>
                                    ` : ''}
                                </div>
                            </div>
                            
                            <!-- Inventaire actuel -->
                            <div class="bg-white rounded-xl shadow-md p-6 md:col-span-2">
                                <h3 class="text-lg font-semibold mb-4">Inventaire actuel</h3>
                                ${Object.keys(currentInventory).length > 0 ? `
                                    <div class="grid grid-cols-2 gap-4">
                                        ${Object.entries(currentInventory).map(([key, data]) => `
                                            <div class="flex justify-between items-center p-3 bg-gray-50 rounded-lg">
                                                <span>${data.name} (${data.size})</span>
                                                <span class="font-semibold">${data.quantity}</span>
                                            </div>
                                        `).join('')}
                                    </div>
                                    <div class="mt-4 p-4 bg-yellow-50 rounded-lg">
                                        <p class="text-sm text-yellow-800">
                                            <strong>Valeur totale:</strong> ${this.calculateInventoryValue(currentInventory)}$
                                        </p>
                                    </div>
                                ` : '<p class="text-gray-500">Aucun uniforme attribué</p>'}
                            </div>
                        </div>
                        
                        <!-- Historique des transactions -->
                        <div class="mt-8 bg-white rounded-xl shadow-md p-6">
                            <h3 class="text-lg font-semibold mb-4">Historique des transactions</h3>
                            ${transactions.length > 0 ? `
                                <div class="overflow-x-auto">
                                    <table class="w-full">
                                        <thead>
                                            <tr class="border-b">
                                                <th class="text-left py-3 px-4">Date</th>
                                                <th class="text-left py-3 px-4">Type</th>
                                                <th class="text-left py-3 px-4">Articles</th>
                                                <th class="text-left py-3 px-4">Statut</th>
                                                <th class="text-left py-3 px-4">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${transactions.map(t => `
                                                <tr class="border-b hover:bg-gray-50">
                                                    <td class="py-3 px-4">${new Date(t.createdAt).toLocaleDateString('fr-CA')}</td>
                                                    <td class="py-3 px-4">
                                                        <span class="px-2 py-1 rounded-full text-sm ${
                                                            t.type === 'attribution' ? 'bg-blue-100 text-blue-800' :
                                                            t.type === 'retour' ? 'bg-green-100 text-green-800' :
                                                            'bg-purple-100 text-purple-800'
                                                        }">
                                                            ${t.type}
                                                        </span>
                                                    </td>
                                                    <td class="py-3 px-4">${t.items.length} article(s)</td>
                                                    <td class="py-3 px-4">
                                                        ${t.type === 'retour' ? 
                                                            '<span class="text-green-600">Complété</span>' :
                                                            t.signed ? 
                                                                '<span class="text-green-600">Signé</span>' :
                                                                '<span class="text-orange-600">En attente</span>'
                                                        }
                                                    </td>
                                                    <td class="py-3 px-4">
                                                        ${t.signed && t.signedPdf ? `
                                                            <button onclick="app.downloadTransactionPDF('${t.id}')" class="text-purple-600 hover:text-purple-800">
                                                                📄 PDF
                                                            </button>
                                                        ` : ''}
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : '<p class="text-gray-500">Aucune transaction</p>'}
                        </div>
                    </div>
                `;
            }

            renderNewTransaction() {
                return `
                    <div class="max-w-2xl mx-auto animate-fadeIn">
                        <h2 class="text-3xl font-bold gradient-text mb-8">Nouvelle transaction</h2>
                        
                        <div class="bg-white rounded-xl shadow-md p-8">
                            <h3 class="text-lg font-semibold mb-6">Sélectionner le type de transaction</h3>
                            
                            <div class="space-y-4">
                                <button onclick="app.selectTransactionType('attribution')" class="w-full text-left p-6 border-2 border-gray-200 rounded-lg hover:border-purple-500 transition group">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h4 class="text-lg font-semibold group-hover:text-purple-600">Attribution initiale</h4>
                                            <p class="text-gray-500 mt-1">Première remise d'uniformes à un nouvel employé</p>
                                        </div>
                                        <svg class="w-8 h-8 text-gray-400 group-hover:text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path>
                                        </svg>
                                    </div>
                                </button>
                                
                                <button onclick="app.selectTransactionType('retour')" class="w-full text-left p-6 border-2 border-gray-200 rounded-lg hover:border-green-500 transition group">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h4 class="text-lg font-semibold group-hover:text-green-600">Retour d'uniformes</h4>
                                            <p class="text-gray-500 mt-1">Enregistrer le retour d'uniformes par un employé</p>
                                        </div>
                                        <svg class="w-8 h-8 text-gray-400 group-hover:text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h10a8 8 0 018 8v2M3 10l6 6m-6-6l6-6"></path>
                                        </svg>
                                    </div>
                                </button>
                                
                                <button onclick="app.selectTransactionType('ajout')" class="w-full text-left p-6 border-2 border-gray-200 rounded-lg hover:border-indigo-500 transition group">
                                    <div class="flex items-center justify-between">
                                        <div>
                                            <h4 class="text-lg font-semibold group-hover:text-indigo-600">Ajout d'uniformes</h4>
                                            <p class="text-gray-500 mt-1">Ajouter des uniformes supplémentaires à un employé existant</p>
                                        </div>
                                        <svg class="w-8 h-8 text-gray-400 group-hover:text-indigo-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path>
                                        </svg>
                                    </div>
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderSelectEmployee() {
                const employees = this.db.getActiveEmployees();
                const searchTerm = localStorage.getItem('employeeSearchTerm') || '';

                const filteredEmployees = employees.filter(emp => 
                    emp.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    emp.id.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (emp.phone && emp.phone.includes(searchTerm))
                );

                return `
                    <div class="max-w-4xl mx-auto animate-fadeIn">
                        <h2 class="text-3xl font-bold gradient-text mb-8">Sélectionner un employé</h2>
                        
                        <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                            <div class="flex gap-4 mb-6">
                                <input type="text" 
                                    id="employeeSearch"
                                    value="${searchTerm}"
                                    placeholder="Rechercher par nom, code ou téléphone..."
                                    class="flex-1 px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    oninput="app.searchEmployees(this.value)">
                                <button onclick="app.showAddEmployeeModal()" class="gradient-bg text-white px-6 py-2 rounded-lg hover:opacity-90 transition">
                                    + Nouvel employé
                                </button>
                            </div>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 max-h-96 overflow-y-auto">
                                ${filteredEmployees.map(emp => `
                                    <div onclick="app.selectEmployee('${emp.id}')" class="p-4 border border-gray-200 rounded-lg hover:border-purple-500 cursor-pointer transition">
                                        <div class="font-semibold">${emp.name}</div>
                                        <div class="text-sm text-gray-500">${emp.id}</div>
                                        ${emp.phone ? `<div class="text-sm text-gray-500">${emp.phone}</div>` : ''}
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }

            renderSelectItems() {
                const inventory = this.db.getInventory();
                const categories = [...new Set(inventory.map(i => i.category))];

                return `
                    <div class="max-w-6xl mx-auto animate-fadeIn">
                        <h2 class="text-3xl font-bold gradient-text mb-8">Sélectionner les articles</h2>
                        
                        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                            <!-- Liste des articles -->
                            <div class="lg:col-span-2">
                                ${categories.map(category => `
                                    <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                                        <h3 class="text-lg font-semibold mb-4">${category}</h3>
                                        <div class="space-y-4">
                                            ${inventory.filter(i => i.category === category).map(item => `
                                                <div class="border border-gray-200 rounded-lg p-4">
                                                    <div class="flex justify-between items-center mb-3">
                                                        <h4 class="font-medium">${item.name}</h4>
                                                        <span class="text-gray-500">${item.price}$/unité</span>
                                                    </div>
                                                    <div class="grid grid-cols-3 gap-2">
                                                        ${Object.entries(item.sizes).map(([size, stock]) => `
                                                            <button 
                                                                onclick="app.addItemToTransaction(${item.id}, '${item.name}', '${size}', ${item.price})"
                                                                class="py-2 px-3 border rounded-lg ${stock > 0 ? 'hover:bg-purple-50 hover:border-purple-500 cursor-pointer' : 'bg-gray-100 text-gray-400 cursor-not-allowed'}"
                                                                ${stock === 0 ? 'disabled' : ''}>
                                                                ${size} (${stock})
                                                            </button>
                                                        `).join('')}
                                                    </div>
                                                </div>
                                            `).join('')}
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                            
                            <!-- Résumé -->
                            <div class="lg:col-span-1">
                                <div class="bg-white rounded-xl shadow-md p-6 sticky top-24">
                                    <h3 class="text-lg font-semibold mb-4">Articles sélectionnés</h3>
                                    <div id="selectedItems" class="space-y-2 mb-4">
                                        ${this.renderSelectedItems()}
                                    </div>
                                    <div class="border-t pt-4">
                                        <div class="flex justify-between mb-2">
                                            <span>Total articles:</span>
                                            <span class="font-semibold">${this.currentTransaction.items.reduce((sum, item) => sum + item.quantity, 0)}</span>
                                        </div>
                                        <div class="flex justify-between mb-4">
                                            <span>Valeur totale:</span>
                                            <span class="font-semibold">${this.currentTransaction.items.reduce((sum, item) => sum + (item.quantity * item.price), 0)}$</span>
                                        </div>
                                        <button 
                                            onclick="app.proceedToSummary()"
                                            class="w-full gradient-bg text-white py-3 rounded-lg hover:opacity-90 transition ${this.currentTransaction.items.length === 0 ? 'opacity-50 cursor-not-allowed' : ''}"
                                            ${this.currentTransaction.items.length === 0 ? 'disabled' : ''}>
                                            Continuer
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderSelectedItems() {
                if (this.currentTransaction.items.length === 0) {
                    return '<p class="text-gray-500 text-center py-4">Aucun article sélectionné</p>';
                }

                return this.currentTransaction.items.map((item, index) => `
                    <div class="flex justify-between items-center p-2 bg-gray-50 rounded">
                        <div class="flex-1">
                            <span class="font-medium">${item.name}</span>
                            <span class="text-sm text-gray-500 ml-2">(${item.size})</span>
                        </div>
                        <div class="flex items-center gap-2">
                            <button onclick="app.updateItemQuantity(${index}, -1)" class="w-8 h-8 border rounded hover:bg-gray-200">-</button>
                            <span class="w-8 text-center">${item.quantity}</span>
                            <button onclick="app.updateItemQuantity(${index}, 1)" class="w-8 h-8 border rounded hover:bg-gray-200">+</button>
                            <button onclick="app.removeItem(${index})" class="ml-2 text-red-600 hover:text-red-800">×</button>
                        </div>
                    </div>
                `).join('');
            }

            renderTransactionSummary() {
                const employee = this.db.getEmployeeById(this.selectedEmployee);
                if (!employee) return '<p>Erreur: Employé non trouvé</p>';

                const total = this.currentTransaction.items.reduce((sum, item) => sum + (item.quantity * item.price), 0);

                return `
                    <div class="max-w-2xl mx-auto animate-fadeIn">
                        <h2 class="text-3xl font-bold gradient-text mb-8">Résumé de la transaction</h2>
                        
                        <div class="bg-white rounded-xl shadow-md p-8">
                            <!-- Type de transaction -->
                            <div class="mb-6">
                                <h3 class="text-sm text-gray-500 mb-1">Type de transaction</h3>
                                <span class="px-3 py-1 rounded-full text-sm font-medium ${
                                    this.currentTransaction.type === 'attribution' ? 'bg-blue-100 text-blue-800' :
                                    this.currentTransaction.type === 'retour' ? 'bg-green-100 text-green-800' :
                                    'bg-purple-100 text-purple-800'
                                }">
                                    ${this.currentTransaction.type}
                                </span>
                            </div>
                            
                            <!-- Employé -->
                            <div class="mb-6">
                                <h3 class="text-sm text-gray-500 mb-1">Employé</h3>
                                <p class="font-semibold">${employee.name}</p>
                                <p class="text-sm text-gray-600">${employee.id}</p>
                            </div>
                            
                            <!-- Articles -->
                            <div class="mb-6">
                                <h3 class="text-sm text-gray-500 mb-3">Articles</h3>
                                <div class="space-y-2">
                                    ${this.currentTransaction.items.map(item => `
                                        <div class="flex justify-between items-center py-2 border-b">
                                            <div>
                                                <span>${item.name} (${item.size})</span>
                                                <span class="text-sm text-gray-500 ml-2">× ${item.quantity}</span>
                                            </div>
                                            <span class="font-medium">${item.quantity * item.price}$</span>
                                        </div>
                                    `).join('')}
                                </div>
                                <div class="flex justify-between items-center mt-4 pt-4 border-t font-semibold">
                                    <span>Total</span>
                                    <span class="text-lg">${total}$</span>
                                </div>
                            </div>
                            
                            <!-- Notes -->
                            <div class="mb-6">
                                <label class="block text-sm text-gray-500 mb-2">Notes (optionnel)</label>
                                <textarea 
                                    id="transactionNotes"
                                    class="w-full px-4 py-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"
                                    rows="3"
                                    placeholder="Ajouter des notes...">${this.currentTransaction.notes}</textarea>
                            </div>
                            
                            <!-- Actions -->
                            <div class="flex gap-4">
                                <button onclick="app.navigate('select-items')" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                                    Retour
                                </button>
                                <button onclick="app.confirmTransaction()" class="flex-1 gradient-bg text-white py-3 rounded-lg hover:opacity-90 transition">
                                    ${this.currentTransaction.type === 'retour' ? 'Confirmer le retour' : 'Envoyer pour signature'}
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }

            renderInventoryManagement() {
                const inventory = this.db.getInventory();
                const lowStockItems = this.db.getLowStockItems();

                return `
                    <div class="animate-fadeIn">
                        <div class="flex justify-between items-center mb-8">
                            <h2 class="text-3xl font-bold gradient-text">Gestion de l'inventaire</h2>
                            <div class="flex gap-4">
                                <button onclick="app.showPurchaseModal()" class="bg-green-600 text-white px-6 py-3 rounded-lg hover:bg-green-700 transition">
                                    + Achat de stock
                                </button>
                                <button onclick="app.showNewItemModal()" class="gradient-bg text-white px-6 py-3 rounded-lg hover:opacity-90 transition">
                                    + Nouvel article
                                </button>
                            </div>
                        </div>
                        
                        <!-- Alertes de stock faible -->
                        ${lowStockItems.length > 0 ? `
                            <div class="bg-red-50 border border-red-200 rounded-xl p-6 mb-6">
                                <h3 class="text-lg font-semibold text-red-800 mb-4">⚠️ Stock faible (< 10 unités)</h3>
                                <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                                    ${lowStockItems.map(item => `
                                        <div class="flex justify-between items-center bg-white p-3 rounded-lg">
                                            <span>${item.name} (${item.size})</span>
                                            <span class="font-semibold text-red-600">${item.quantity}</span>
                                        </div>
                                    `).join('')}
                                </div>
                            </div>
                        ` : ''}
                        
                        <!-- Inventaire par catégorie -->
                        ${[...new Set(inventory.map(i => i.category))].map(category => `
                            <div class="bg-white rounded-xl shadow-md p-6 mb-6">
                                <h3 class="text-lg font-semibold mb-4">${category}</h3>
                                <div class="overflow-x-auto">
                                    <table class="w-full">
                                        <thead>
                                            <tr class="border-b">
                                                <th class="text-left py-3 px-4">Article</th>
                                                <th class="text-left py-3 px-4">Prix</th>
                                                ${category === 'Bas' ? 
                                                    '<th class="text-center py-3 px-4">28</th><th class="text-center py-3 px-4">30</th><th class="text-center py-3 px-4">32</th><th class="text-center py-3 px-4">34</th><th class="text-center py-3 px-4">36</th><th class="text-center py-3 px-4">38</th><th class="text-center py-3 px-4">40</th>' :
                                                    category === 'Accessoires' || category === 'Sécurité' ? 
                                                        '<th class="text-center py-3 px-4">Stock</th>' :
                                                        '<th class="text-center py-3 px-4">S</th><th class="text-center py-3 px-4">M</th><th class="text-center py-3 px-4">L</th><th class="text-center py-3 px-4">XL</th><th class="text-center py-3 px-4">XXL</th><th class="text-center py-3 px-4">3XL</th>'
                                                }
                                                <th class="text-center py-3 px-4">Total</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${inventory.filter(i => i.category === category).map(item => `
                                                <tr class="border-b hover:bg-gray-50">
                                                    <td class="py-3 px-4 font-medium">${item.name}</td>
                                                    <td class="py-3 px-4">${item.price}$</td>
                                                    ${Object.entries(item.sizes).map(([size, qty]) => `
                                                        <td class="text-center py-3 px-4">
                                                            <button onclick="app.showAdjustStockModal(${item.id}, '${size}')" 
                                                                class="hover:bg-gray-200 px-2 py-1 rounded ${qty < 10 ? 'text-red-600 font-semibold' : ''}">
                                                                ${qty}
                                                            </button>
                                                        </td>
                                                    `).join('')}
                                                    ${Object.keys(item.sizes).length === 1 && category !== 'Bas' ? '<td></td><td></td><td></td><td></td><td></td>' : ''}
                                                    <td class="text-center py-3 px-4 font-semibold">
                                                        ${Object.values(item.sizes).reduce((a, b) => a + b, 0)}
                                                    </td>
                                                </tr>
                                            `).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            renderTransactionsList() {
                const transactions = this.db.getTransactions().sort((a, b) => new Date(b.createdAt) - new Date(a.createdAt));

                return `
                    <div class="animate-fadeIn">
                        <h2 class="text-3xl font-bold gradient-text mb-8">Historique des transactions</h2>
                        
                        <div class="bg-white rounded-xl shadow-md overflow-hidden">
                            ${transactions.length > 0 ? `
                                <div class="overflow-x-auto">
                                    <table class="w-full">
                                        <thead class="bg-gray-50">
                                            <tr>
                                                <th class="text-left py-4 px-6">Date</th>
                                                <th class="text-left py-4 px-6">Type</th>
                                                <th class="text-left py-4 px-6">Employé</th>
                                                <th class="text-left py-4 px-6">Articles</th>
                                                <th class="text-left py-4 px-6">Valeur</th>
                                                <th class="text-left py-4 px-6">Statut</th>
                                                <th class="text-left py-4 px-6">Actions</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${transactions.map(t => {
                                                const employee = this.db.getEmployeeById(t.employeeId);
                                                const total = t.items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
                                                return `
                                                    <tr class="border-b hover:bg-gray-50">
                                                        <td class="py-4 px-6">${new Date(t.createdAt).toLocaleDateString('fr-CA')}</td>
                                                        <td class="py-4 px-6">
                                                            <span class="px-2 py-1 rounded-full text-sm ${
                                                                t.type === 'attribution' ? 'bg-blue-100 text-blue-800' :
                                                                t.type === 'retour' ? 'bg-green-100 text-green-800' :
                                                                'bg-purple-100 text-purple-800'
                                                            }">
                                                                ${t.type}
                                                            </span>
                                                        </td>
                                                        <td class="py-4 px-6">${employee ? employee.name : 'Employé supprimé'}</td>
                                                        <td class="py-4 px-6">${t.items.reduce((sum, item) => sum + item.quantity, 0)} articles</td>
                                                        <td class="py-4 px-6">${total}$</td>
                                                        <td class="py-4 px-6">
                                                            ${t.type === 'retour' ? 
                                                                '<span class="text-green-600">Complété</span>' :
                                                                t.signed ? 
                                                                    '<span class="text-green-600">Signé</span>' :
                                                                    '<span class="text-orange-600">En attente</span>'
                                                            }
                                                        </td>
                                                        <td class="py-4 px-6">
                                                            ${t.signed && t.signedPdf ? `
                                                                <button onclick="app.downloadTransactionPDF('${t.id}')" class="text-purple-600 hover:text-purple-800">
                                                                    📄 PDF
                                                                </button>
                                                            ` : ''}
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            ` : '<p class="text-gray-500 text-center py-8">Aucune transaction</p>'}
                        </div>
                    </div>
                `;
            }

            renderPendingSignatures() {
                const pendingSignatures = this.db.getPendingSignatures();

                return `
                    <div class="animate-fadeIn">
                        <h2 class="text-3xl font-bold gradient-text mb-8">Signatures en attente</h2>
                        
                        <div class="bg-white rounded-xl shadow-md p-6">
                            ${pendingSignatures.length > 0 ? `
                                <div class="space-y-4">
                                    ${pendingSignatures.map(t => {
                                        const employee = this.db.getEmployeeById(t.employeeId);
                                        const signatureLink = `${window.location.origin}${window.location.pathname}?token=${t.linkToken}`;
                                        return `
                                            <div class="border border-gray-200 rounded-lg p-4">
                                                <div class="flex justify-between items-start">
                                                    <div>
                                                        <h3 class="font-semibold">${employee ? employee.name : 'Employé supprimé'}</h3>
                                                        <p class="text-sm text-gray-500">
                                                            ${new Date(t.createdAt).toLocaleDateString('fr-CA')} - ${t.type}
                                                        </p>
                                                        <p class="text-sm text-gray-500">${t.items.length} article(s)</p>
                                                    </div>
                                                    <button onclick="app.copySignatureLink('${signatureLink}')" class="gradient-bg text-white px-4 py-2 rounded-lg hover:opacity-90 transition">
                                                        Copier le lien
                                                    </button>
                                                </div>
                                                <div class="mt-3 p-3 bg-gray-50 rounded">
                                                    <p class="text-xs text-gray-600 break-all">${signatureLink}</p>
                                                </div>
                                            </div>
                                        `;
                                    }).join('')}
                                </div>
                            ` : '<p class="text-gray-500 text-center py-8">Aucune signature en attente</p>'}
                        </div>
                    </div>
                `;
            }

            showSignaturePage(transaction) {
                const employee = this.db.getEmployeeById(transaction.employeeId);
                if (!employee) {
                    alert('Employé non trouvé');
                    window.location.search = '';
                    return;
                }

                const total = transaction.items.reduce((sum, item) => sum + (item.quantity * item.price), 0);

                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen bg-gray-50 py-8">
                        <div class="max-w-2xl mx-auto px-4">
                            <div class="bg-white rounded-xl shadow-md p-8 animate-fadeIn">
                                <div class="text-center mb-8">
                                    <h1 class="text-3xl font-bold gradient-text mb-2">XGuard</h1>
                                    <p class="text-gray-600">Confirmation de réception d'uniformes</p>
                                </div>
                                
                                <div class="mb-6">
                                    <h2 class="text-xl font-semibold mb-4">Informations</h2>
                                    <div class="space-y-2">
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Employé:</span>
                                            <span class="font-medium">${employee.name}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Code:</span>
                                            <span class="font-medium">${employee.id}</span>
                                        </div>
                                        <div class="flex justify-between">
                                            <span class="text-gray-600">Date:</span>
                                            <span class="font-medium">${new Date().toLocaleDateString('fr-CA')}</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-6">
                                    <h2 class="text-xl font-semibold mb-4">Articles reçus</h2>
                                    <div class="space-y-2">
                                        ${transaction.items.map(item => `
                                            <div class="flex justify-between items-center py-2 border-b">
                                                <div>
                                                    <span>${item.name} (${item.size})</span>
                                                    <span class="text-sm text-gray-500 ml-2">× ${item.quantity}</span>
                                                </div>
                                                <span class="font-medium">${item.quantity * item.price}$</span>
                                            </div>
                                        `).join('')}
                                        <div class="flex justify-between items-center pt-4 font-semibold text-lg">
                                            <span>Total</span>
                                            <span>${total}$</span>
                                        </div>
                                    </div>
                                </div>
                                
                                <div class="mb-6 p-4 bg-yellow-50 rounded-lg">
                                    <h3 class="font-semibold text-yellow-800 mb-2">⚠️ Important</h3>
                                    <ul class="text-sm text-yellow-700 space-y-1">
                                        <li>• Les uniformes demeurent la propriété de XGuard</li>
                                        <li>• Ils doivent être retournés en bon état à la fin de l'emploi</li>
                                        <li>• En cas de non-retour, le montant total de ${total}$ sera retenu sur la dernière paie</li>
                                        <li>• L'employé est responsable de l'entretien des uniformes</li>
                                    </ul>
                                </div>
                                
                                <div class="mb-6">
                                    <label class="flex items-start">
                                        <input type="checkbox" id="acceptTerms" class="mt-1 mr-3">
                                        <span class="text-sm">
                                            Je confirme avoir reçu les uniformes listés ci-dessus et j'accepte les conditions mentionnées.
                                        </span>
                                    </label>
                                </div>
                                
                                <div class="mb-6">
                                    <label class="block text-sm font-medium mb-2">Signature</label>
                                    <canvas id="signature-pad" width="600" height="200"></canvas>
                                    <button onclick="app.clearSignature()" class="mt-2 text-sm text-gray-600 hover:text-gray-800">
                                        Effacer la signature
                                    </button>
                                </div>
                                
                                <div class="flex gap-4">
                                    <button onclick="app.cancelSignature()" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg hover:bg-gray-50 transition">
                                        Annuler
                                    </button>
                                    <button onclick="app.submitSignature('${transaction.id}')" class="flex-1 gradient-bg text-white py-3 rounded-lg hover:opacity-90 transition">
                                        Signer et confirmer
                                    </button>
                                </div>
                            </div>
                        </div>
                    </div>
                `;

                this.initSignaturePad();
            }

            initSignaturePad() {
                const canvas = document.getElementById('signature-pad');
                const ctx = canvas.getContext('2d');
                
                let isDrawing = false;
                let lastX = 0;
                let lastY = 0;

                canvas.addEventListener('mousedown', startDrawing);
                canvas.addEventListener('mousemove', draw);
                canvas.addEventListener('mouseup', stopDrawing);
                canvas.addEventListener('mouseout', stopDrawing);
                
                canvas.addEventListener('touchstart', handleTouch);
                canvas.addEventListener('touchmove', handleTouch);
                canvas.addEventListener('touchend', stopDrawing);

                function startDrawing(e) {
                    isDrawing = true;
                    [lastX, lastY] = getCoordinates(e);
                }

                function draw(e) {
                    if (!isDrawing) return;
                    
                    const [currentX, currentY] = getCoordinates(e);
                    
                    ctx.beginPath();
                    ctx.moveTo(lastX, lastY);
                    ctx.lineTo(currentX, currentY);
                    ctx.strokeStyle = '#000';
                    ctx.lineWidth = 2;
                    ctx.lineCap = 'round';
                    ctx.stroke();
                    
                    [lastX, lastY] = [currentX, currentY];
                }

                function stopDrawing() {
                    isDrawing = false;
                }

                function getCoordinates(e) {
                    const rect = canvas.getBoundingClientRect();
                    return [
                        e.clientX - rect.left,
                        e.clientY - rect.top
                    ];
                }

                function handleTouch(e) {
                    e.preventDefault();
                    const touch = e.touches[0];
                    const mouseEvent = new MouseEvent(e.type === 'touchstart' ? 'mousedown' : e.type === 'touchmove' ? 'mousemove' : 'mouseup', {
                        clientX: touch.clientX,
                        clientY: touch.clientY
                    });
                    canvas.dispatchEvent(mouseEvent);
                }

                this.signaturePad = { canvas, ctx };
            }

            clearSignature() {
                if (this.signaturePad) {
                    this.signaturePad.ctx.clearRect(0, 0, this.signaturePad.canvas.width, this.signaturePad.canvas.height);
                }
            }

            cancelSignature() {
                if (confirm('Êtes-vous sûr de vouloir annuler?')) {
                    window.location.search = '';
                    this.init();
                }
            }

            async submitSignature(transactionId) {
                const acceptTerms = document.getElementById('acceptTerms').checked;
                if (!acceptTerms) {
                    alert('Veuillez accepter les conditions avant de signer.');
                    return;
                }

                if (!this.signaturePad || this.isCanvasEmpty(this.signaturePad.canvas)) {
                    alert('Veuillez signer avant de soumettre.');
                    return;
                }

                const signatureData = this.signaturePad.canvas.toDataURL();
                const transaction = this.db.getTransactionById(transactionId);
                const employee = this.db.getEmployeeById(transaction.employeeId);

                // Mettre à jour l'inventaire
                transaction.items.forEach(item => {
                    const invItem = this.db.getInventory().find(i => i.name === item.name);
                    if (invItem) {
                        this.db.updateInventoryStock(invItem.id, item.size, item.quantity, 'remove');
                    }
                });

                // Générer le PDF signé
                const pdfData = await this.generateSignedPDF(transaction, employee, signatureData);

                // Mettre à jour la transaction
                this.db.updateTransaction(transactionId, {
                    signed: true,
                    signedAt: new Date().toISOString(),
                    signature: {
                        data: signatureData,
                        timestamp: new Date().toISOString()
                    },
                    signedPdf: pdfData
                });

                // Afficher la page de confirmation avec option de téléchargement
                document.getElementById('app').innerHTML = `
                    <div class="min-h-screen bg-gray-50 py-8">
                        <div class="max-w-2xl mx-auto px-4">
                            <div class="bg-white rounded-xl shadow-md p-8 text-center animate-fadeIn">
                                <div class="w-20 h-20 bg-green-100 rounded-full flex items-center justify-center mx-auto mb-6">
                                    <svg class="w-10 h-10 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path>
                                    </svg>
                                </div>
                                <h2 class="text-2xl font-bold mb-4">Signature enregistrée!</h2>
                                <p class="text-gray-600 mb-8">
                                    La transaction a été complétée avec succès.
                                    Vous pouvez télécharger une copie du document signé.
                                </p>
                                <button onclick="app.downloadPDFAndClose('${transactionId}')" class="gradient-bg text-white px-8 py-3 rounded-lg hover:opacity-90 transition">
                                    📄 Télécharger le PDF
                                </button>
                                <p class="text-sm text-gray-500 mt-4">
                                    Cette page se fermera automatiquement dans 10 secondes...
                                </p>
                            </div>
                        </div>
                    </div>
                `;

                setTimeout(() => {
                    window.location.search = '';
                    this.init();
                }, 10000);
            }

            async generateSignedPDF(transaction, employee, signatureData) {
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                // En-tête
                doc.setFontSize(24);
                doc.setTextColor(102, 126, 234);
                doc.text('XGuard', 105, 20, { align: 'center' });
                
                doc.setFontSize(14);
                doc.setTextColor(0, 0, 0);
                doc.text('Confirmation de réception d\'uniformes', 105, 30, { align: 'center' });

                // Informations
                doc.setFontSize(12);
                doc.text('Informations de l\'employé', 20, 50);
                doc.setFontSize(10);
                doc.text(`Nom: ${employee.name}`, 20, 60);
                doc.text(`Code: ${employee.id}`, 20, 67);
                doc.text(`Date: ${new Date().toLocaleDateString('fr-CA')}`, 20, 74);
                doc.text(`Type: ${transaction.type}`, 20, 81);

                // Articles
                doc.setFontSize(12);
                doc.text('Articles reçus', 20, 95);
                
                let y = 105;
                const total = transaction.items.reduce((sum, item) => sum + (item.quantity * item.price), 0);
                
                doc.setFontSize(10);
                transaction.items.forEach(item => {
                    doc.text(`${item.name} (${item.size}) x ${item.quantity}`, 20, y);
                    doc.text(`${item.quantity * item.price}$`, 180, y, { align: 'right' });
                    y += 7;
                });

                doc.line(20, y, 190, y);
                y += 7;
                doc.setFontSize(12);
                doc.text('Total:', 20, y);
                doc.text(`${total}$`, 180, y, { align: 'right' });

                // Conditions
                y += 15;
                doc.setFontSize(11);
                doc.text('Conditions importantes:', 20, y);
                y += 10;
                doc.setFontSize(9);
                const conditions = [
                    '• Les uniformes demeurent la propriété de XGuard',
                    '• Ils doivent être retournés en bon état à la fin de l\'emploi',
                    `• En cas de non-retour, ${total}$ sera retenu sur la dernière paie`,
                    '• L\'employé est responsable de l\'entretien des uniformes'
                ];
                conditions.forEach(condition => {
                    doc.text(condition, 25, y);
                    y += 7;
                });

                // Signature
                y += 10;
                doc.setFontSize(10);
                doc.text('Signature de l\'employé:', 20, y);
                
                // Ajouter l'image de la signature
                const imgWidth = 60;
                const imgHeight = 20;
                doc.addImage(signatureData, 'PNG', 20, y + 5, imgWidth, imgHeight);
                
                doc.text(`Signé le: ${new Date().toLocaleString('fr-CA')}`, 20, y + 30);

                // Notes si présentes
                if (transaction.notes) {
                    y += 40;
                    doc.setFontSize(10);
                    doc.text('Notes:', 20, y);
                    doc.setFontSize(9);
                    const splitNotes = doc.splitTextToSize(transaction.notes, 170);
                    doc.text(splitNotes, 20, y + 7);
                }

                // Convertir en base64
                return doc.output('datauristring');
            }

            downloadPDFAndClose(transactionId) {
                this.downloadTransactionPDF(transactionId);
                setTimeout(() => {
                    window.location.search = '';
                    this.init();
                }, 2000);
            }

            downloadTransactionPDF(transactionId) {
                const transaction = this.db.getTransactionById(transactionId);
                if (transaction && transaction.signedPdf) {
                    const link = document.createElement('a');
                    link.href = transaction.signedPdf;
                    link.download = `XGuard_${transaction.employeeId}_${new Date(transaction.signedAt).toISOString().split('T')[0]}.pdf`;
                    link.click();
                }
            }

            isCanvasEmpty(canvas) {
                const ctx = canvas.getContext('2d');
                const pixelBuffer = new Uint32Array(
                    ctx.getImageData(0, 0, canvas.width, canvas.height).data.buffer
                );
                return !pixelBuffer.some(color => color !== 0);
            }

            // Méthodes de navigation et actions
            navigate(view) {
                this.currentView = view;
                this.render();
            }

            startNewTransaction() {
                this.currentTransaction = {
                    type: null,
                    items: [],
                    notes: ''
                };
                this.selectedEmployee = null;
                this.navigate('new-transaction');
            }

            selectTransactionType(type) {
                this.currentTransaction.type = type;
                this.navigate('select-employee');
            }

            searchEmployees(term) {
                localStorage.setItem('employeeSearchTerm', term);
                this.render();
            }

            selectEmployee(employeeId) {
                this.selectedEmployee = employeeId;
                this.navigate('select-items');
            }

            addItemToTransaction(itemId, name, size, price) {
                const existingIndex = this.currentTransaction.items.findIndex(
                    i => i.name === name && i.size === size
                );
                
                if (existingIndex !== -1) {
                    this.currentTransaction.items[existingIndex].quantity++;
                } else {
                    this.currentTransaction.items.push({
                        itemId,
                        name,
                        size,
                        quantity: 1,
                        price
                    });
                }
                
                document.getElementById('selectedItems').innerHTML = this.renderSelectedItems();
            }

            updateItemQuantity(index, delta) {
                const item = this.currentTransaction.items[index];
                item.quantity = Math.max(1, item.quantity + delta);
                document.getElementById('selectedItems').innerHTML = this.renderSelectedItems();
            }

            removeItem(index) {
                this.currentTransaction.items.splice(index, 1);
                document.getElementById('selectedItems').innerHTML = this.renderSelectedItems();
            }

            proceedToSummary() {
                if (this.currentTransaction.items.length === 0) return;
                this.currentTransaction.notes = '';
                this.navigate('transaction-summary');
            }

            async confirmTransaction() {
                const notes = document.getElementById('transactionNotes').value;
                this.currentTransaction.notes = notes;

                const transaction = this.db.addTransaction({
                    type: this.currentTransaction.type,
                    employeeId: this.selectedEmployee,
                    items: this.currentTransaction.items,
                    notes: notes,
                    createdBy: 'Réceptionniste'
                });

                if (this.currentTransaction.type === 'retour') {
                    // Pour les retours, mettre à jour l'inventaire immédiatement
                    this.currentTransaction.items.forEach(item => {
                        const invItem = this.db.getInventory().find(i => i.name === item.name);
                        if (invItem) {
                            this.db.updateInventoryStock(invItem.id, item.size, item.quantity, 'add');
                        }
                    });
                    
                    alert('Retour enregistré avec succès!');
                    this.navigate('home');
                } else {
                    // Pour attribution/ajout, afficher le lien de signature
                    const signatureLink = `${window.location.origin}${window.location.pathname}?token=${transaction.linkToken}`;
                    
                    const modal = document.createElement('div');
                    modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                    modal.innerHTML = `
                        <div class="bg-white rounded-xl p-8 max-w-lg w-full mx-4 animate-fadeIn">
                            <h3 class="text-xl font-semibold mb-4">Transaction créée!</h3>
                            <p class="mb-4">Envoyez ce lien à l'employé pour obtenir sa signature:</p>
                            <div class="p-3 bg-gray-100 rounded mb-4">
                                <p class="text-sm break-all">${signatureLink}</p>
                            </div>
                            <div class="flex gap-4">
                                <button onclick="app.copySignatureLink('${signatureLink}')" class="flex-1 gradient-bg text-white py-2 rounded-lg hover:opacity-90">
                                    Copier le lien
                                </button>
                                <button onclick="this.closest('.fixed').remove(); app.navigate('home')" class="flex-1 border border-gray-300 py-2 rounded-lg hover:bg-gray-50">
                                    Fermer
                                </button>
                            </div>
                        </div>
                    `;
                    document.body.appendChild(modal);
                }
            }

            copySignatureLink(link) {
                navigator.clipboard.writeText(link);
                alert('Lien copié!');
            }

            toggleEmployeeTab(showInactive) {
                localStorage.setItem('showInactiveEmployees', showInactive);
                this.render();
            }

            toggleEmployeeStatus(employeeId) {
                const employee = this.db.getEmployeeById(employeeId);
                if (employee) {
                    if (employee.active) {
                        // Vérifier si l'employé a des uniformes non retournés
                        const inventory = this.calculateEmployeeInventory(employeeId);
                        if (Object.keys(inventory).length > 0) {
                            alert('L\'employé doit retourner tous ses uniformes avant d\'être désactivé.');
                            return;
                        }
                    }
                    this.db.updateEmployee(employeeId, { active: !employee.active });
                    this.render();
                }
            }

            viewEmployeeDetail(employeeId) {
                this.selectedEmployee = employeeId;
                this.navigate('employee-detail');
            }

            calculateEmployeeInventory(employeeId) {
                const transactions = this.db.getTransactionsByEmployee(employeeId);
                const inventory = {};

                transactions.forEach(t => {
                    if (t.signed || t.type === 'retour') {
                        t.items.forEach(item => {
                            const key = `${item.name}_${item.size}`;
                            if (!inventory[key]) {
                                inventory[key] = {
                                    name: item.name,
                                    size: item.size,
                                    quantity: 0,
                                    price: item.price
                                };
                            }
                            
                            if (t.type === 'retour') {
                                inventory[key].quantity -= item.quantity;
                            } else {
                                inventory[key].quantity += item.quantity;
                            }
                        });
                    }
                });

                // Retirer les articles avec quantité 0 ou négative
                Object.keys(inventory).forEach(key => {
                    if (inventory[key].quantity <= 0) {
                        delete inventory[key];
                    }
                });

                return inventory;
            }

            calculateInventoryValue(inventory) {
                return Object.values(inventory).reduce((sum, item) => sum + (item.quantity * item.price), 0);
            }

            showAddEmployeeModal() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 animate-fadeIn">
                        <h3 class="text-xl font-semibold mb-6">Nouvel employé</h3>
                        <form onsubmit="event.preventDefault(); app.addEmployee();">
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2">Nom complet *</label>
                                <input type="text" id="newEmployeeName" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2">Téléphone</label>
                                <input type="tel" id="newEmployeePhone" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2">Email</label>
                                <input type="email" id="newEmployeeEmail" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div class="mb-6">
                                <label class="block text-sm font-medium mb-2">Notes</label>
                                <textarea id="newEmployeeNotes" rows="3" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500"></textarea>
                            </div>
                            <div class="flex gap-4">
                                <button type="button" onclick="this.closest('.fixed').remove()" class="flex-1 border border-gray-300 py-2 rounded-lg hover:bg-gray-50">
                                    Annuler
                                </button>
                                <button type="submit" class="flex-1 gradient-bg text-white py-2 rounded-lg hover:opacity-90">
                                    Créer
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                document.body.appendChild(modal);
                document.getElementById('newEmployeeName').focus();
            }

            addEmployee() {
                const name = document.getElementById('newEmployeeName').value.trim();
                const phone = document.getElementById('newEmployeePhone').value.trim();
                const email = document.getElementById('newEmployeeEmail').value.trim();
                const notes = document.getElementById('newEmployeeNotes').value.trim();

                if (!name) {
                    alert('Le nom est requis');
                    return;
                }

                const newEmployee = this.db.addEmployee({
                    name,
                    phone: phone || null,
                    email: email || null,
                    notes: notes || null
                });

                document.querySelector('.fixed').remove();
                
                if (this.currentView === 'select-employee') {
                    this.selectEmployee(newEmployee.id);
                } else {
                    this.render();
                }
            }

            showPurchaseModal() {
                const inventory = this.db.getInventory();
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl p-8 max-w-2xl w-full mx-4 max-h-[90vh] overflow-y-auto animate-fadeIn">
                        <h3 class="text-xl font-semibold mb-6">Achat de stock</h3>
                        <div class="mb-4">
                            <label class="block text-sm font-medium mb-2">Article</label>
                            <select id="purchaseItem" onchange="app.updatePurchaseSizes()" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                <option value="">Sélectionner un article</option>
                                ${inventory.map(item => `<option value="${item.id}">${item.name}</option>`).join('')}
                            </select>
                        </div>
                        <div id="purchaseSizes" class="mb-6"></div>
                        <div class="flex gap-4">
                            <button type="button" onclick="this.closest('.fixed').remove()" class="flex-1 border border-gray-300 py-2 rounded-lg hover:bg-gray-50">
                                Annuler
                            </button>
                            <button onclick="app.processPurchase()" class="flex-1 bg-green-600 text-white py-2 rounded-lg hover:bg-green-700">
                                Enregistrer l'achat
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            updatePurchaseSizes() {
                const itemId = document.getElementById('purchaseItem').value;
                const sizesDiv = document.getElementById('purchaseSizes');
                
                if (!itemId) {
                    sizesDiv.innerHTML = '';
                    return;
                }

                const item = this.db.getInventoryItem(parseInt(itemId));
                sizesDiv.innerHTML = `
                    <label class="block text-sm font-medium mb-2">Quantités par taille</label>
                    <div class="grid grid-cols-3 gap-3">
                        ${Object.entries(item.sizes).map(([size, current]) => `
                            <div>
                                <label class="text-sm text-gray-600">${size} (actuel: ${current})</label>
                                <input type="number" 
                                    id="purchase_${size}" 
                                    min="0" 
                                    placeholder="0"
                                    class="w-full px-3 py-2 border rounded focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                        `).join('')}
                    </div>
                `;
            }

            processPurchase() {
                const itemId = document.getElementById('purchaseItem').value;
                if (!itemId) {
                    alert('Veuillez sélectionner un article');
                    return;
                }

                const item = this.db.getInventoryItem(parseInt(itemId));
                let totalAdded = 0;

                Object.keys(item.sizes).forEach(size => {
                    const input = document.getElementById(`purchase_${size}`);
                    const quantity = parseInt(input.value) || 0;
                    if (quantity > 0) {
                        this.db.updateInventoryStock(item.id, size, quantity, 'add');
                        totalAdded += quantity;
                    }
                });

                if (totalAdded > 0) {
                    alert(`${totalAdded} unités ajoutées à l'inventaire!`);
                    document.querySelector('.fixed').remove();
                    this.render();
                } else {
                    alert('Aucune quantité spécifiée');
                }
            }

            showAdjustStockModal(itemId, size) {
                const item = this.db.getInventoryItem(itemId);
                const currentStock = item.sizes[size];
                
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 animate-fadeIn">
                        <h3 class="text-xl font-semibold mb-6">Ajuster le stock</h3>
                        <p class="mb-4">${item.name} - Taille ${size}</p>
                        <div class="mb-6">
                            <label class="block text-sm font-medium mb-2">Nouvelle quantité (actuelle: ${currentStock})</label>
                            <input type="number" 
                                id="adjustedStock" 
                                value="${currentStock}" 
                                min="0"
                                class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                        </div>
                        <div class="flex gap-4">
                            <button type="button" onclick="this.closest('.fixed').remove()" class="flex-1 border border-gray-300 py-2 rounded-lg hover:bg-gray-50">
                                Annuler
                            </button>
                            <button onclick="app.adjustStock(${itemId}, '${size}')" class="flex-1 gradient-bg text-white py-2 rounded-lg hover:opacity-90">
                                Ajuster
                            </button>
                        </div>
                    </div>
                `;
                document.body.appendChild(modal);
                document.getElementById('adjustedStock').select();
            }

            adjustStock(itemId, size) {
                const newQuantity = parseInt(document.getElementById('adjustedStock').value);
                if (isNaN(newQuantity) || newQuantity < 0) {
                    alert('Quantité invalide');
                    return;
                }

                this.db.updateInventoryStock(itemId, size, newQuantity, 'adjust');
                document.querySelector('.fixed').remove();
                this.render();
            }

            showNewItemModal() {
                const modal = document.createElement('div');
                modal.className = 'fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50';
                modal.innerHTML = `
                    <div class="bg-white rounded-xl p-8 max-w-md w-full mx-4 animate-fadeIn">
                        <h3 class="text-xl font-semibold mb-6">Nouvel article</h3>
                        <form onsubmit="event.preventDefault(); app.addNewItem();">
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2">Nom de l'article *</label>
                                <input type="text" id="newItemName" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2">Catégorie *</label>
                                <select id="newItemCategory" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <option value="Hauts">Hauts</option>
                                    <option value="Bas">Bas</option>
                                    <option value="Extérieur">Extérieur</option>
                                    <option value="Accessoires">Accessoires</option>
                                    <option value="Sécurité">Sécurité</option>
                                </select>
                            </div>
                            <div class="mb-4">
                                <label class="block text-sm font-medium mb-2">Prix unitaire *</label>
                                <input type="number" id="newItemPrice" required min="0" step="0.01" class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                            </div>
                            <div class="mb-6">
                                <label class="block text-sm font-medium mb-2">Type de tailles *</label>
                                <select id="newItemSizeType" required class="w-full px-4 py-2 border rounded-lg focus:outline-none focus:ring-2 focus:ring-purple-500">
                                    <option value="standard">Standard (S, M, L, XL, XXL, 3XL)</option>
                                    <option value="pantalon">Pantalon (28-40)</option>
                                    <option value="unique">Taille unique</option>
                                    <option value="custom">Personnalisé</option>
                                </select>
                            </div>
                            <div class="flex gap-4">
                                <button type="button" onclick="this.closest('.fixed').remove()" class="flex-1 border border-gray-300 py-2 rounded-lg hover:bg-gray-50">
                                    Annuler
                                </button>
                                <button type="submit" class="flex-1 gradient-bg text-white py-2 rounded-lg hover:opacity-90">
                                    Créer
                                </button>
                            </div>
                        </form>
                    </div>
                `;
                document.body.appendChild(modal);
            }

            addNewItem() {
                const name = document.getElementById('newItemName').value.trim();
                const category = document.getElementById('newItemCategory').value;
                const price = parseFloat(document.getElementById('newItemPrice').value);
                const sizeType = document.getElementById('newItemSizeType').value;

                if (!name || !price) {
                    alert('Veuillez remplir tous les champs requis');
                    return;
                }

                let sizes = {};
                switch(sizeType) {
                    case 'standard':
                        sizes = { S: 0, M: 0, L: 0, XL: 0, XXL: 0, '3XL': 0 };
                        break;
                    case 'pantalon':
                        sizes = { '28': 0, '30': 0, '32': 0, '34': 0, '36': 0, '38': 0, '40': 0 };
                        break;
                    case 'unique':
                        sizes = { 'Unique': 0 };
                        break;
                    case 'custom':
                        // Pour custom, on pourrait ajouter une interface pour définir les tailles
                        sizes = { 'S': 0, 'M': 0, 'L': 0 };
                        break;
                }

                this.db.addInventoryItem({
                    name,
                    category,
                    price,
                    sizes
                });

                alert('Article ajouté avec succès!');
                document.querySelector('.fixed').remove();
                this.render();
            }

            exportData() {
                const data = this.db.exportData();
                const dataStr = JSON.stringify(data, null, 2);
                const dataUri = 'data:application/json;charset=utf-8,'+ encodeURIComponent(dataStr);
                
                const exportName = `xguard_backup_${new Date().toISOString().split('T')[0]}.json`;
                
                const linkElement = document.createElement('a');
                linkElement.setAttribute('href', dataUri);
                linkElement.setAttribute('download', exportName);
                linkElement.click();
            }

            attachEventListeners() {
                // Les event listeners sont déjà attachés inline dans le HTML
            }
        }

        // Initialiser l'application
        const app = new XGuardApp();
    </script>
</body>
</html>
